{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="section-content padding-y bg">
  <div class="container">

    <!-- Back Button -->
    <aside class="col-md-3 mb-4">
      {% if user.user_type != 'admin' %}
      <button class="btn btn-light btn-block" onclick="window.history.back();">
        <i class="fa fa-arrow-left"></i> <span class="text">Back</span>
      </button>
      {% else %}
      <a href="{% url 'admin_dashboard' %}" class="btn btn-light btn-block">
        <i class="fa fa-arrow-left"></i> <span class="text">Back </span>
      </a>
      {% endif %}
    </aside>
     {% include 'includes/alerts.html' %}
    <!-- ============================ COMPLAINT DETAIL CARD ================================= -->
    <div class="card h-100 shadow-sm position-relative mb-5 p-3">

      <!-- Status Badge -->
      <span class="badge position-absolute top-0 end-0 m-3 px-3 py-2 fs-6
        {% if complaint.status %}
          {% if complaint.status.name == 'Pending' %} bg-danger text-white
          {% elif complaint.status.name == 'In Progress' %} bg-warning text-dark
          {% elif complaint.status.name == 'Resolved' %} bg-success text-white
          {% else %} bg-secondary text-white
          {% endif %}
        {% else %}
          bg-secondary text-white
        {% endif %}">
        {{ complaint.status.name|default:"N/A" }}
      </span>

      <!-- Complaint Image -->
      {% if complaint.image %}
        <img src="{{ complaint.image.url }}" class="card-img-top mb-4" alt="Complaint Image"
             style="width: 100%; height: 500px; object-fit: contain" />
      {% else %}
        <img src="{% static 'images/complain.png' %}" class="card-img-top mb-4" alt="No Image"
             style="width: 100%; height: 500px; object-fit: contain" />
      {% endif %}

      <div class="card-body d-flex flex-column">
        <h2 class="card-title mb-3">{{ complaint.title }}</h2>

        <p class="medium text-muted mb-3" style="font-size: 1rem; color: black">
          <strong>Date:</strong> {{ complaint.created_at|date:"Y-m-d" }}<br />
          <strong>Posted by:</strong> {{ complaint.user.username }}<br />
          {% if  user.user_type == 'municipality' %}
          <strong>Contact:</strong> {{ complaint.user.phone_number }}<br />
          <strong>Email:</strong> {{ complaint.user.email }}<br />
          {% endif %}
          <strong>Municipality:</strong> {{ complaint.ward|default:"N/A" }}<br />
          <strong>Ward:</strong> 
          {% if complaint.ward %}Ward-{{ complaint.ward.ward_number }}{% else %}N/A{% endif %}<br />
          <strong>Category:</strong> {{ complaint.category.category_name|default:"N/A" }}
        </p>

        <p class="card-text flex-grow-1 mb-4" style="font-size: 1rem">
          {{ complaint.description }}
        </p>

        <!-- ============================ ACTION BUTTONS ============================ -->
        {% if  user.user_type != 'admin' %}
        <div class="d-flex justify-content-between align-items-center mt-auto">

          <!-- Like Button -->
          {% if user != complaint.user and user.user_type != 'municipality' %}
            <form method="POST" action="{% url 'like_complaint' complaint.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger">
                <i class="fas fa-heart"></i> {{ complaint.likes.count }}
              </button>
            </form>
          {% else %}
            <button class="btn btn-sm btn-outline-danger" disabled>
              <i class="fas fa-heart"></i> {{ complaint.likes.count }}
            </button>
          {% endif %}

          <!-- Comment Button -->
              {% if user != complaint.user and user.user_type != 'municipality' %}
              <a href="{% url 'post_detail' complaint.id %}">
                <button class="btn btn-sm btn-outline-secondary">
                  <i class="fas fa-comments"></i> {{ complaint.comments.count }}
                </button>
              </a>
               {% else %}
                <button class="btn btn-sm btn-outline-secondary" disabled>
                  <i class="fas fa-comments"></i> {{ complaint.comments.count }}
                </button>
                {% endif %}

          <!-- Report Button -->
          {% if user != complaint.user and user.user_type != 'municipality' %}
            <form method="POST" action="{% url 'report_complaint' complaint.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-warning">
                <i class="fas fa-flag"></i> {{ complaint.reports.count }}
              </button>
            </form>
          {% else %}
            <button class="btn btn-sm btn-outline-warning" disabled>
              <i class="fas fa-flag"></i> {{ complaint.reports.count }}
            </button>
          {% endif %}

            <!-- Edit Button -->
              {% if user == complaint.user and user.user_type != 'municipality' %}
              <a href="{% url 'edit_complaint' complaint.id %}">
                <button class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-edit"></i> 
                </button>
              </a>
               {% else %}
                <button class="btn btn-sm btn-outline-primary" disabled>
                  <i class="fas fa-edit"></i> 
                </button>
              {% endif %}

              {% comment %} Delete button {% endcomment %}
              {% if user == complaint.user and user.user_type != 'municipality' %}
              <form method="POST" action="{% url 'delete_complaint' complaint.id %}" style="display:inline;" 
                    onsubmit="return confirm('Are you sure you want to delete this complaint?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Complaint">
                      <i class="fas fa-trash"></i>
                  </button>
              </form>
              {% else %}
              <button class="btn btn-sm btn-outline-danger" disabled title="You can't delete this">
                  <i class="fas fa-trash"></i>
              </button>
              {% endif %}
     

              {% comment %} Update staus {% endcomment %}
            {% if user.user_type == 'municipality' %}   
            <form method="post" action="{% url 'update_complaint_status' complaint.id %}" class="d-flex align-items-center gap-2">
                {% csrf_token %}
                <select name="status" class="form-control me-2" required style="max-width: 200px;">
                    <option value="">Set Status</option>
                    {% for status in statuses %}
                        <option value="{{ status.id }}" {% if complaint.status.id == status.id %}selected{% endif %}>
                            {{ status.name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class=" ml-4 btn btn-primary">Update</button>
            </form>
            {% endif %} 
          </div>  

          {% elif user.user_type == 'admin' %}
          <div class="d-flex justify-content-between align-items-center mt-auto">

          {% comment %} Delete  {% endcomment %}
           <form method="POST" action="{% url 'admin_delete_complaint' complaint.id %}" style="display:inline;" 
                    onsubmit="return confirm('Are you sure you want to delete this complaint?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Complaint">
                      <i class="fas fa-trash"></i>
                  </button>
             </form>
          
         {% comment %} Update staus {% endcomment %}
         <form method="post" action="{% url 'update_complaint_visibility' complaint.id %}" class="d-flex align-items-center mt-2 gap-2">
              {% csrf_token %}
              <select name="is_hidden" class="form-control me-2" required style="max-width: 200px;">
                  {% if complaint.is_hidden %}
                      <option value="false" selected>Unhide</option>
                  {% else %}
                      <option value="true" selected>Hide</option>
                  {% endif %}
              </select>
              <button type="submit" class="ml-4 btn btn-warning">Update</button>
          </form>

        </div>  
        {% endif %}
      </div>
    </div>
    <!-- ============================ COMPLAINT DETAIL CARD END ============================ -->

    <!-- ========================= COMMENT SECTION ========================= -->
   
    <section class="my-5">
      {% if  user.user_type != 'admin' %}
      {% if request.user != complaint.user and user.user_type != 'municipality' %} 
        <form method="POST" action="{% url 'comment_complaint' complaint.id %}" class="mt-4">
          {% csrf_token %}
          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="mb-3">Leave a Comment</h6>
              <div class="mb-3">
                <textarea class="form-control" name="comment" rows="3"
                          placeholder="Write your comment here..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
            </div>
          </div>
        </form>
      {% endif %}
      {% endif %}

      <h3 class="mb-4 mt-5">Comments</h3>

 {% for comment in complaint.comments.all %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-1">{{ comment.user.username }}</h6>
        <small class="text-muted">{{ comment.created_at|date:"F d, Y, P" }}</small>

        <div>
          
          {% if user == comment.user and user.user_type != 'municipality' %}
          {% if user.user_type != 'admin'%}
          <form method="POST" action="{% url 'edit_comment' comment.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-primary" title="Delete Comment">
                  <i class="fas fa-edit"></i>
              </button>
          </form>
          {% else %}
          <button class="btn btn-sm btn-outline-primary" disabled title="You can't delete this">
              <i class="fas fa-edit"></i>
          </button>
          {% endif %}
          {% endif %}
        </div>

        <!-- Delete button container -->
        <div>
          {% if user.user_type != 'municipality' %}
              {% if user == comment.user or user == complaint.user %}
          <form method="POST" action="{% url 'delete_comment' comment.id %}" style="display:inline;"
                onsubmit="return confirm('Are you sure you want to delete this comment?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Comment">
                  <i class="fas fa-trash"></i>
              </button>
          </form>
          {% elif user.user_type == 'admin'%}
          <form method="POST" action="{% url 'admin_delete_comment' comment.id %}" style="display:inline;"
                onsubmit="return confirm('Are you sure you want to delete this comment?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Comment">
                  <i class="fas fa-trash"></i>
              </button>
          </form>
          {% else %}
          <button class="btn btn-sm btn-outline-danger" disabled title="You can't delete this">
              <i class="fas fa-trash"></i>
          </button>
          {% endif %}
          {% endif %}
        </div>
      </div>
      <p class="mb-0">{{ comment.content }}</p>
    </div>
  </div>
{% empty %}
  <p>No comments yet.</p>
{% endfor %}
</section>

    <!-- ========================= COMMENT SECTION END ========================= -->

  </div>
</section>

{% endblock %}
